<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Crusher (Update Fitur Lokasi)</title>
    <style>
        :root {
            --primary-color: #2c3e50; 
            --secondary-color: #34495e;
            --accent-color: #e67e22; 
            --bg-light: #ecf0f1;
            --text-dark: #2c3e50;
            --text-light: #ffffff;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .hidden { display: none !important; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; margin-left: 5px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--secondary-color); }
        .btn-accent { background-color: var(--accent-color); color: white; }
        .btn-accent:hover { opacity: 0.9; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: #f39c12; color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-print { background-color: #7f8c8d; color: white; } 
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        /* Auth */
        #auth-section {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        .auth-box {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .auth-header { text-align: center; margin-bottom: 20px; }
        .auth-header h2 { color: var(--primary-color); }
        .toggle-link {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
            display: block;
            margin-top: 10px;
            text-align: center;
        }

        /* Layout */
        #app-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        aside {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            transition: 0.3s;
            flex-shrink: 0;
        }
        .brand {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 30px;
            color: var(--accent-color);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        nav ul { list-style: none; }
        nav li { margin-bottom: 5px; }
        nav button {
            width: 100%;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 15px 20px;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }
        nav button:hover, nav button.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-left: 4px solid var(--accent-color);
        }
        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }

        /* Main Content */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--bg-light);
        }

        h2.section-title {
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            display: inline-block;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--accent-color);
        }
        .stat-number { font-size: 2rem; font-weight: bold; color: var(--primary-color); }
        .stat-label { color: #7f8c8d; }

        /* Filter & List */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            align-items: center;
        }
        .filter-bar input {
            flex: 2;
            min-width: 200px;
        }
        .filter-bar select {
            flex: 1;
            min-width: 120px;
        }

        .data-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .data-item {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
            display: flex;
            align-items: flex-start; 
            flex-wrap: wrap;
            page-break-inside: avoid;
            position: relative;
        }
        .data-item.status-damage { border-left-color: var(--danger-color); }
        .data-item.status-repaired { border-left-color: var(--success-color); }
        .data-item.status-cost { border-left-color: var(--accent-color); }
        .data-item.status-receiving { border-left-color: #3498db; }

        .item-checkbox {
            margin-right: 15px;
            margin-top: 5px;
            transform: scale(1.5); 
            cursor: pointer;
        }
        
        .item-content { flex: 1; padding-right: 15px; min-width: 250px; }
        .item-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .item-title { font-weight: bold; font-size: 1.1rem; }
        .item-date { font-size: 0.85rem; color: #95a5a6; }
        .item-location { 
            display: inline-block; 
            background: #dfe6e9; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 0.8rem; 
            margin-bottom: 5px;
            font-weight: 600;
        }
        .item-desc { font-size: 0.95rem; color: #34495e; margin-bottom: 10px; }
        
        .item-media {
            max-width: 150px;
            max-height: 100px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid #ddd;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .ttd-preview {
            border: 1px dashed #ccc;
            padding: 5px;
            background: #fff;
            max-width: 100px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            align-items: center;
        }

        /* Canvas */
        canvas {
            border: 2px dashed #ccc;
            background: #fff;
            cursor: crosshair;
            border-radius: 4px;
            touch-action: none;
            width: 100%;
            max-width: 300px;
        }
        .canvas-container {
            margin-top: 10px;
            text-align: center;
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Responsive */
        @media (max-width: 768px) {
            #app-layout { flex-direction: column; }
            aside { width: 100%; height: auto; flex-direction: row; align-items: center; padding: 10px; justify-content: space-between; overflow-x: auto; }
            .brand { margin: 0; border: none; font-size: 1.2rem; white-space: nowrap; }
            nav ul { display: flex; }
            nav button { padding: 10px; font-size: 0.9rem; }
            .user-info { display: none; }
            .data-item { flex-direction: column; }
            .item-media { max-width: 100%; max-height: 200px; }
        }

        /* --- PRINT STYLES --- */
        @media print {
            body {
                height: auto;
                background-color: white;
                display: block;
            }
            #auth-section, aside, .filter-bar, .action-buttons, .toast, .item-checkbox {
                display: none !important;
            }
            .data-item.unchecked-print {
                display: none !important;
            }
            #app-layout {
                display: block;
                height: auto;
                overflow: visible;
            }
            main {
                padding: 0;
                overflow: visible;
            }
            #view-history {
                display: block !important;
            }
            #view-dashboard, #view-damage, #view-cost, #view-repair, #view-receiving {
                display: none !important;
            }
            .card {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }
            .data-item {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
                margin-bottom: 15px;
                padding: 15px; 
            }
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }
            .print-header h1 { font-size: 24px; margin-bottom: 5px; }
            .print-header p { font-size: 14px; color: #555; }
        }
        
        .print-header { display: none; }

    </style>
</head>
<body>

    <div id="toast">Notifikasi</div>

    <!-- 1. AUTH -->
    <section id="auth-section">
        <div class="auth-box">
            <div class="auth-header">
                <h2>CRUSHER SYSTEM</h2>
                <p>Login ke Akun Anda</p>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="login-username" class="form-control" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">MASUK</button>
                <a class="toggle-link" onclick="toggleAuth('register')">Belum punya akun? Daftar</a>
            </form>

            <form id="register-form" class="hidden">
                <div class="form-group">
                    <label>Username Baru</label>
                    <input type="text" id="reg-username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="reg-password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-accent" style="width: 100%;">DAFTAR</button>
                <a class="toggle-link" onclick="toggleAuth('login')">Sudah punya akun? Login</a>
            </form>
        </div>
    </section>

    <!-- 2. APP LAYOUT -->
    <section id="app-layout" class="hidden">
        <aside>
            <div class="brand">CRUSHER APP</div>
            <nav>
                <ul>
                    <li><button class="active" onclick="navigate('dashboard')">üè† Dashboard</button></li>
                    <li><button onclick="navigate('damage')">‚ö†Ô∏è Kerusakan Alat</button></li>
                    <li><button onclick="navigate('cost')">üí∞ Biaya Ganti Alat</button></li>
                    <li><button onclick="navigate('repair')">üîß Perbaikan Selesai</button></li>
                    <li><button onclick="navigate('receiving')">üì¶ Penerimaan Barang</button></li>
                    <li><button onclick="navigate('history')">üìú Riwayat Laporan</button></li>
                    <li><button onclick="logout()" style="margin-top: 20px; color: #ff7675;">üö™ Keluar</button></li>
                </ul>
            </nav>
            <div class="user-info">
                Login sebagai: <br>
                <strong id="display-username">User</strong>
            </div>
        </aside>

        <main>
            <!-- DASHBOARD -->
            <div id="view-dashboard">
                <h2 class="section-title">Dashboard Crusher</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="stat-damage">0</div>
                        <div class="stat-label">Laporan Kerusakan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-repair">0</div>
                        <div class="stat-label">Perbaikan Selesai</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-cost">Rp 0</div>
                        <div class="stat-label">Total Biaya Perbaikan</div>
                    </div>
                </div>
                <div class="card">
                    <h3>Aktivitas Terbaru</h3>
                    <div id="dashboard-recent-list" class="data-list"></div>
                </div>
            </div>

            <!-- FORMS -->
            <!-- DAMAGE -->
            <div id="view-damage" class="hidden">
                <h2 class="section-title">Laporan Kerusakan Alat</h2>
                <div class="card">
                    <form id="form-damage" onsubmit="handleFormSubmit(event, 'damage')">
                        <input type="hidden" id="damage-edit-id">
                        <div class="form-group">
                            <label>Tanggal Laporan</label>
                            <input type="date" id="damage-date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Lokasi / Area</label>
                            <select id="damage-location" class="form-control" onchange="handleUnitSelection('damage', this.value)" required>
                                <option value="">Pilih Lokasi...</option>
                                <!-- Diisi oleh JavaScript -->
                            </select>
                        </div>
                        <div id="damage-unit-container" class="form-group hidden">
                            <label>Pilih Unit BC</label>
                            <select id="damage-unit" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Deskripsi Kerusakan</label>
                            <textarea id="damage-desc" name="desc" class="form-control" rows="3" placeholder="Jelaskan kerusakan..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Dokumentasi Foto</label>
                            <input type="file" id="damage-file" accept="image/*" class="form-control" onchange="previewImage(this, 'preview-damage')">
                            <input type="hidden" id="damage-old-image">
                            <img id="preview-damage" class="item-media hidden" style="margin-top: 10px;">
                        </div>
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-danger" id="btn-submit-damage">LAPORKAN KERUSAKAN</button>
                            <button type="button" class="btn btn-warning hidden" id="btn-cancel-damage" onclick="cancelEdit('damage')">BATAL EDIT</button>
                        </div>
                    </form>
                </div>
                <div id="list-damage" class="data-list"></div>
            </div>

            <!-- COST -->
            <div id="view-cost" class="hidden">
                <h2 class="section-title">Log Biaya Penggantian Alat</h2>
                <div class="card">
                    <form id="form-cost" onsubmit="handleFormSubmit(event, 'cost')">
                        <input type="hidden" id="cost-edit-id">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="date" id="cost-date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Lokasi / Area</label>
                            <select id="cost-location" class="form-control" onchange="handleUnitSelection('cost', this.value)" required>
                                <option value="">Pilih Lokasi...</option>
                                <!-- Diisi oleh JavaScript -->
                            </select>
                        </div>
                        <div id="cost-unit-container" class="form-group hidden">
                            <label>Pilih Unit BC</label>
                            <select id="cost-unit" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Nama Alat / Sparepart</label>
                            <input type="text" id="cost-name" name="itemName" class="form-control" placeholder="Contoh: Bearing Jaw Crusher" required>
                        </div>
                        <div class="form-group">
                            <label>Biaya (Rp)</label>
                            <input type="number" id="cost-val" name="cost" class="form-control" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label>Dokumentasi Foto Barang/Nota</label>
                            <input type="file" id="cost-file" accept="image/*" class="form-control" onchange="previewImage(this, 'preview-cost')">
                            <input type="hidden" id="cost-old-image">
                            <img id="preview-cost" class="item-media hidden" style="margin-top: 10px;">
                        </div>
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-accent" id="btn-submit-cost">SIMPAN BIAYA</button>
                            <button type="button" class="btn btn-warning hidden" id="btn-cancel-cost" onclick="cancelEdit('cost')">BATAL EDIT</button>
                        </div>
                    </form>
                </div>
                <div id="list-cost" class="data-list"></div>
            </div>

            <!-- REPAIR -->
            <div id="view-repair" class="hidden">
                <h2 class="section-title">Laporan Perbaikan Selesai</h2>
                <div class="card">
                    <form id="form-repair" onsubmit="handleFormSubmit(event, 'repair')">
                        <input type="hidden" id="repair-edit-id">
                        <div class="form-group">
                            <label>Tanggal Selesai</label>
                            <input type="date" id="repair-date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Lokasi / Area</label>
                            <select id="repair-location" class="form-control" onchange="handleUnitSelection('repair', this.value)" required>
                                <option value="">Pilih Lokasi...</option>
                                <!-- Diisi oleh JavaScript -->
                            </select>
                        </div>
                        <div id="repair-unit-container" class="form-group hidden">
                            <label>Pilih Unit BC</label>
                            <select id="repair-unit" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Detail Perbaikan</label>
                            <textarea id="repair-desc" name="desc" class="form-control" rows="3" placeholder="Apa yang diperbaiki?" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Dokumentasi Foto Setelah Perbaikan</label>
                            <input type="file" id="repair-file" accept="image/*" class="form-control" onchange="previewImage(this, 'preview-repair')">
                            <input type="hidden" id="repair-old-image">
                            <img id="preview-repair" class="item-media hidden" style="margin-top: 10px;">
                        </div>
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-primary" id="btn-submit-repair">TANDAI SELESAI</button>
                            <button type="button" class="btn btn-warning hidden" id="btn-cancel-repair" onclick="cancelEdit('repair')">BATAL EDIT</button>
                        </div>
                    </form>
                </div>
                <div id="list-repair" class="data-list"></div>
            </div>

            <!-- RECEIVING -->
            <div id="view-receiving" class="hidden">
                <h2 class="section-title">Penerimaan Barang</h2>
                <div class="card">
                    <form id="form-receiving" onsubmit="handleFormSubmit(event, 'receiving')">
                        <input type="hidden" id="receiving-edit-id">
                        <div class="form-group">
                            <label>Tanggal Terima</label>
                            <input type="date" id="receiving-date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nama Barang / Supplier</label>
                            <input type="text" id="receiving-name" name="itemName" class="form-control" placeholder="Contoh: Plate Steel 20mm dari PT ABC" required>
                        </div>
                        <div class="form-group">
                            <label>Jumlah / Kondisi</label>
                            <textarea id="receiving-desc" name="desc" class="form-control" rows="2" placeholder="Jumlah barang dan kondisi fisik..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Dokumentasi Foto Barang</label>
                            <input type="file" id="receiving-file" accept="image/*" class="form-control" onchange="previewImage(this, 'preview-receiving')">
                            <input type="hidden" id="receiving-old-image">
                            <img id="preview-receiving" class="item-media hidden" style="margin-top: 10px;">
                        </div>
                        <div class="form-group">
                            <label>Tanda Tangan Penerima (TTD)</label>
                            <div class="canvas-container">
                                <canvas id="ttd-canvas" width="300" height="150"></canvas>
                                <button type="button" class="btn btn-sm" style="margin-top:5px; font-size: 0.8rem;" onclick="clearCanvas()">Hapus TTD</button>
                            </div>
                            <small style="display:block; margin-top:5px; color:#7f8c8d;">* Jika Edit, kosongkan canvas untuk menggunakan TTD lama.</small>
                            <input type="hidden" id="receiving-old-ttd">
                        </div>
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-primary" id="btn-submit-receiving">TERIMA BARANG</button>
                            <button type="button" class="btn btn-warning hidden" id="btn-cancel-receiving" onclick="cancelEdit('receiving')">BATAL EDIT</button>
                        </div>
                    </form>
                </div>
                <div id="list-receiving" class="data-list"></div>
            </div>

            <!-- HISTORY -->
            <div id="view-history" class="hidden">
                <div class="print-header">
                    <h1>LAPORAN CRUSHER SYSTEM</h1>
                    <p>Dicetak oleh: <span id="print-username"></span> | Tanggal Cetak: <span id="print-date"></span></p>
                    <p style="margin-top:10px; font-weight:bold;">Filter: <span id="print-filter-info"></span></p>
                </div>

                <h2 class="section-title">Riwayat Laporan</h2>
                
                <div class="filter-bar">
                    <!-- Search Text -->
                    <input type="text" id="history-search" class="form-control" placeholder="Cari Nama Sparepart, Tanggal, atau Pelapor..." onkeyup="renderHistory()">
                    
                    <!-- Filter Kategori -->
                    <select id="history-type-filter" class="form-control" onchange="renderHistory()">
                        <option value="all">Semua Kategori</option>
                        <option value="damage">Kerusakan</option>
                        <option value="cost">Biaya</option>
                        <option value="repair">Perbaikan</option>
                        <option value="receiving">Penerimaan</option>
                    </select>

                    <!-- FILTER LOKASI (BARU) -->
                    <select id="history-location-filter" class="form-control" onchange="renderHistory()">
                        <option value="all">Semua Lokasi</option>
                        <!-- Opsi lokasi akan diisi oleh JavaScript -->
                    </select>

                    <!-- Urutan -->
                    <select id="history-sort" class="form-control" onchange="renderHistory()">
                        <option value="newest">Terbaru</option>
                        <option value="oldest">Terlama</option>
                    </select>

                    <button type="button" class="btn btn-sm btn-primary" onclick="toggleAllCheckboxes(true)">Pilih Semua</button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="toggleAllCheckboxes(false)">Batal Pilih</button>

                    <button class="btn btn-print" onclick="printSelected()">
                        üñ®Ô∏è Cetak Terpilih
                    </button>
                </div>

                <div id="list-history" class="data-list"></div>
            </div>

        </main>
    </section>

    <script>
        // --- DATA KONFIGURASI LOKASI ---
        const LOCATIONS = [
            { id: 'hopper', name: 'Hopper Crusher', isMulti: false },
            { id: 'jaw', name: 'Jaw Crusher', isMulti: false },
            { id: 'whosing', name: 'Whosing', isMulti: false },
            { id: 'ds1', name: 'Double Screen 1', isMulti: false },
            { id: 'ds2', name: 'Double Screen 2', isMulti: false },
            { id: 'handpicking', name: 'Handpicking', isMulti: false },
            { id: 'cone', name: 'Cone Crusher', isMulti: false },
            { id: 'bc', name: 'BC (Belt Conveyor)', isMulti: true, rangeStart: 1, rangeEnd: 15 }
        ];

        // --- STATE MANAGEMENT ---
        let currentUser = localStorage.getItem('crusherUser') || null;
        let appData = JSON.parse(localStorage.getItem('crusherAppData')) || {
            damage: [],
            cost: [],
            repair: [],
            receiving: []
        };

        let editState = {
            active: false,
            type: null,
            id: null
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (currentUser) {
                showApp();
            } else {
                showAuth();
            }
            initForms();
            setupCanvas();
        });

        function toggleAuth(type) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const title = document.querySelector('.auth-header h2');
            const p = document.querySelector('.auth-header p');

            if (type === 'register') {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                title.innerText = "PENDAFTARAN";
                p.innerText = "Buat akun baru";
            } else {
                regForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                title.innerText = "CRUSHER SYSTEM";
                p.innerText = "Login ke Akun Anda";
            }
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            if (u && p) {
                currentUser = u;
                localStorage.setItem('crusherUser', currentUser);
                showToast("Login Berhasil!");
                showApp();
            }
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('reg-username').value;
            const p = document.getElementById('reg-password').value;
            if (u && p) {
                showToast("Registrasi Berhasil! Silakan Login.");
                toggleAuth('login');
            }
        });

        function logout() {
            localStorage.removeItem('crusherUser');
            currentUser = null;
            showAuth();
        }

        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-layout').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-layout').classList.remove('hidden');
            document.getElementById('display-username').innerText = currentUser;
            navigate('dashboard');
        }

        // --- NAVIGATION ---
        function navigate(viewId) {
            if(editState.active) cancelEdit(editState.type);

            ['dashboard', 'damage', 'cost', 'repair', 'receiving', 'history'].forEach(id => {
                document.getElementById('view-' + id).classList.add('hidden');
            });
            document.getElementById('view-' + viewId).classList.remove('hidden');
            
            // Highlight tombol aktif di sidebar
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            if(event && event.target.closest('button')) {
                event.target.closest('button').classList.add('active');
            }

            if (viewId === 'dashboard') updateDashboard();
            else if (viewId === 'history') renderHistory();
            else renderList(viewId);
        }

        // --- FORM HANDLING & LOCATION LOGIC ---
        function initForms() {
            // 1. Isi Dropdown Lokasi di Form Input (Damage, Cost, Repair)
            ['damage', 'cost', 'repair'].forEach(formType => {
                const select = document.getElementById(formType + '-location');
                select.innerHTML = '<option value="">Pilih Lokasi...</option>';
                LOCATIONS.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.id;
                    option.text = loc.name;
                    select.appendChild(option);
                });
            });

            // 2. Isi Dropdown Lokasi di Filter History (BARU)
            const historyFilter = document.getElementById('history-location-filter');
            historyFilter.innerHTML = '<option value="all">Semua Lokasi</option>';
            
            // Tambahkan lokasi statis
            LOCATIONS.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.id;
                option.text = loc.name;
                historyFilter.appendChild(option);
            });

            // Jika ada data BC dalam riwayat, tambahkan unit spesifik yang sudah ada ke filter juga
            // (Opsional: agar user bisa filter "BC - Unit 5" langsung)
            const usedUnits = new Set();
            ['damage', 'cost', 'repair'].forEach(type => {
                appData[type].forEach(item => {
                    if(item.locationId === 'bc' && item.unitId) {
                        usedUnits.add(item.unitId);
                    }
                });
            });
            
            if(usedUnits.size > 0) {
                const groupOpt = document.createElement('optgroup');
                groupOpt.label = "Belt Conveyor (Unit Spesifik)";
                usedUnits.forEach(unit => {
                    const opt = document.createElement('option');
                    opt.value = `bc-unit-${unit}`;
                    opt.text = `BC - Unit ${unit}`;
                    groupOpt.appendChild(opt);
                });
                historyFilter.appendChild(groupOpt);
            }

            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.valueAsDate = new Date();
            });
        }

        function handleUnitSelection(formType, locationId) {
            const container = document.getElementById(formType + '-unit-container');
            const unitSelect = document.getElementById(formType + '-unit');
            const locationData = LOCATIONS.find(l => l.id === locationId);

            if (locationData && locationData.isMulti) {
                container.classList.remove('hidden');
                unitSelect.innerHTML = '<option value="">Pilih Nomor Unit...</option>';
                for (let i = locationData.rangeStart; i <= locationData.rangeEnd; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = "Unit " + i;
                    unitSelect.appendChild(opt);
                }
                unitSelect.setAttribute('required', 'true');
            } else {
                container.classList.add('hidden');
                unitSelect.innerHTML = '';
                unitSelect.removeAttribute('required');
                unitSelect.value = ""; 
            }
        }

        function previewImage(input, imgId) {
            const img = document.getElementById(imgId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- EDIT DATA ---
        function editData(type, id) {
            const index = appData[type].findIndex(item => item.id === id);
            if (index === -1) return;
            const item = appData[type][index];

            editState = { active: true, type: type, id: id };
            navigate(type);

            document.getElementById(type + '-edit-id').value = item.id;
            document.getElementById(type + '-date').value = item.date;
            
            const locSelect = document.getElementById(type + '-location');
            
            // Pastikan dropdown terisi ulang jika kosong
            if (locSelect.options.length <= 1) {
                initForms(); 
            }
            
            // Set Nilai Lokasi
            locSelect.value = item.locationId;
            
            // Trigger handleUnitSelection untuk memunculkan dropdown unit jika perlu
            handleUnitSelection(type, item.locationId);
            
            // Set Nilai Unit (Jika ada)
            if (item.unitId) {
                const unitSelect = document.getElementById(type + '-unit');
                unitSelect.value = item.unitId;
            }

            // Isi field lain
            if (type === 'damage' || type === 'repair') {
                document.getElementById(type + '-desc').value = item.desc;
            } else if (type === 'cost') {
                document.getElementById(type + '-name').value = item.itemName;
                document.getElementById(type + '-val').value = item.cost;
            } else if (type === 'receiving') {
                document.getElementById(type + '-name').value = item.itemName;
                document.getElementById(type + '-desc').value = item.supplierNote;
                document.getElementById('receiving-old-ttd').value = item.ttd || "";
            }

            // Handle Image
            const oldImgInput = document.getElementById(type + '-old-image');
            oldImgInput.value = item.image || "";
            const preview = document.getElementById('preview-' + type);
            if (item.image) {
                preview.src = item.image;
                preview.classList.remove('hidden');
            } else {
                preview.src = "";
                preview.classList.add('hidden');
            }

            // UI Button State
            const btnSubmit = document.getElementById('btn-submit-' + type);
            btnSubmit.innerText = "UPDATE DATA";
            btnSubmit.classList.remove('btn-danger', 'btn-primary', 'btn-accent');
            btnSubmit.classList.add('btn-success'); 
            
            document.getElementById('btn-cancel-' + type).classList.remove('hidden');
            
            showToast("Mode Edit Aktif");
        }

        function cancelEdit(type) {
            document.getElementById('form-' + type).reset();
            document.getElementById(type + '-date').valueAsDate = new Date();
            document.getElementById('preview-' + type).classList.add('hidden');
            document.getElementById('preview-' + type).src = "";
            if(type === 'receiving') clearCanvas();

            const btnSubmit = document.getElementById('btn-submit-' + type);
            btnSubmit.classList.remove('btn-success');
            
            // Reset warna tombol ke asal
            if(type === 'damage') btnSubmit.classList.add('btn-danger');
            else if(type === 'cost') btnSubmit.classList.add('btn-accent');
            else btnSubmit.classList.add('btn-primary');

            // Reset teks tombol
            if(type === 'damage') btnSubmit.innerText = "LAPORKAN KERUSAKAN";
            else if(type === 'cost') btnSubmit.innerText = "SIMPAN BIAYA";
            else if(type === 'repair') btnSubmit.innerText = "TANDAI SELESAI";
            else if(type === 'receiving') btnSubmit.innerText = "TERIMA BARANG";

            document.getElementById('btn-cancel-' + type).classList.add('hidden');
            editState = { active: false, type: null, id: null };
            
            const unitContainer = document.getElementById(type + '-unit-container');
            if(unitContainer) unitContainer.classList.add('hidden');
        }

        function handleFormSubmit(e, type) {
            e.preventDefault();
            const form = document.getElementById('form-' + type);
            const formData = new FormData(form);
            
            const locSelect = document.getElementById(type + '-location');
            const locData = LOCATIONS.find(l => l.id === locSelect.value);
            const locName = locData ? locData.name : locSelect.value;
            
            const unitContainer = document.getElementById(type + '-unit-container');
            let unitVal = "";
            let fullLocation = locName;
            
            // Jika ada dropdown Unit (BC), gabungkan nama lokasi dengan nomor unit
            if (!unitContainer.classList.contains('hidden')) {
                unitVal = document.getElementById(type + '-unit').value;
                if(unitVal) fullLocation += ` - Unit ${unitVal}`;
            }

            let finalImage = document.getElementById(type + '-old-image').value;
            const fileInput = document.getElementById(type + '-file');
            if (fileInput.files && fileInput.files[0]) {
                finalImage = document.getElementById('preview-' + type).src;
            }

            let finalTtd = null;
            if (type === 'receiving') {
                const oldTtd = document.getElementById('receiving-old-ttd').value;
                const canvas = document.getElementById('ttd-canvas');
                const currentTtdData = canvas.toDataURL();
                if (currentTtdData.length < 1000 && oldTtd) {
                    finalTtd = oldTtd;
                } else {
                    finalTtd = currentTtdData;
                }
            }

            const itemBase = {
                date: formData.get('date'),
                locationId: locSelect.value, // Simpan ID Lokasi (contoh: 'bc')
                location: fullLocation,     // Simpan Nama Tampilan (contoh: 'BC - Unit 2')
                unitId: unitVal,            // Simpan Nomor Unit jika ada
                user: currentUser,
                image: finalImage
            };

            if (type === 'receiving') {
                itemBase.itemName = formData.get('itemName');
                itemBase.supplierNote = formData.get('desc');
                itemBase.desc = `${formData.get('itemName')} - ${formData.get('desc')}`;
                itemBase.ttd = finalTtd;
            } else {
                itemBase.desc = formData.get('desc') || formData.get('itemName');
                if(type === 'cost') {
                    itemBase.itemName = formData.get('itemName');
                    itemBase.cost = formData.get('cost');
                }
            }

            if (editState.active && editState.id) {
                const index = appData[type].findIndex(i => i.id == editState.id);
                if (index !== -1) {
                    itemBase.id = appData[type][index].id;
                    appData[type][index] = itemBase;
                    showToast("Data Berhasil Diupdate!");
                }
                cancelEdit(type);
            } else {
                itemBase.id = Date.now();
                appData[type].unshift(itemBase);
                showToast("Data Berhasil Disimpan!");
                form.reset();
                document.getElementById('preview-' + type).src = '';
                document.getElementById('preview-' + type).classList.add('hidden');
                if(type === 'receiving') clearCanvas();
                document.getElementById(type + '-date').valueAsDate = new Date();
            }

            saveData();
            // Refresh filter history jika ada data baru
            if(document.getElementById('view-history').classList.contains('hidden') === false) {
                initForms(); // Refresh filter lokasi
                renderHistory();
            }
        }

        function saveData() {
            localStorage.setItem('crusherAppData', JSON.stringify(appData));
        }

        function renderList(type) {
            const container = document.getElementById('list-' + type);
            container.innerHTML = '';
            const data = appData[type];
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Belum ada data.</p>';
                return;
            }
            data.forEach(item => {
                const el = createItemElement(item, type);
                container.appendChild(el);
            });
        }

        function renderHistory() {
            const container = document.getElementById('list-history');
            const searchVal = document.getElementById('history-search').value.toLowerCase();
            const typeFilter = document.getElementById('history-type-filter').value;
            const locationFilter = document.getElementById('history-location-filter').value; // AMBIL VALUE FILTER LOKASI
            const sortVal = document.getElementById('history-sort').value;

            document.getElementById('print-username').innerText = currentUser;
            const today = new Date();
            document.getElementById('print-date').innerText = today.toLocaleDateString('id-ID') + ' ' + today.toLocaleTimeString('id-ID');
            
            let filterText = "Semua Data";
            
            if (typeFilter !== 'all') filterText = typeFilter.toUpperCase();
            if(locationFilter !== 'all') {
                // Cari nama lokasi dari ID untuk ditampilkan di print
                const locName = Array.from(document.getElementById('history-location-filter').options)
                    .find(o => o.value === locationFilter)?.text || locationFilter;
                filterText += ` | Lokasi: ${locName}`;
            }
            if(searchVal) filterText += ` (Cari: "${searchVal}")`;
            
            document.getElementById('print-filter-info').innerText = filterText;

            let allData = [];
            ['damage', 'cost', 'repair', 'receiving'].forEach(type => {
                appData[type].forEach(item => {
                    allData.push({ ...item, type: type });
                });
            });

            // --- LOGIKA FILTER BARU ---
            if (typeFilter !== 'all') {
                allData = allData.filter(item => item.type === typeFilter);
            }

            // Filter Lokasi
            if (locationFilter !== 'all') {
                allData = allData.filter(item => {
                    // Cek jika filter memilih Unit Spesifik (misal: bc-unit-5)
                    if(locationFilter.startsWith('bc-unit-')) {
                        const filterUnit = locationFilter.split('-')[2];
                        return item.locationId === 'bc' && item.unitId == filterUnit;
                    } 
                    // Cek jika filter memilih Lokasi Umum (misal: 'bc', 'jaw')
                    else {
                        return item.locationId === locationFilter;
                    }
                });
            }

            // Filter Pencarian Teks
            if (searchVal) {
                allData = allData.filter(item => {
                    const searchStr = (item.desc + " " + item.date + " " + item.user + " " + (item.itemName || "")).toLowerCase();
                    return searchStr.includes(searchVal);
                });
            }

            // Sorting
            if (sortVal === 'newest') {
                allData.sort((a, b) => b.id - a.id);
            } else {
                allData.sort((a, b) => a.id - b.id);
            }

            container.innerHTML = '';
            if (allData.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Tidak ada data yang cocok.</p>';
                return;
            }

            allData.forEach(item => {
                const el = createItemElement(item, item.type, true); 
                container.appendChild(el);
            });
        }

        function createItemElement(item, type, showCheckbox = false) {
            const el = document.createElement('div');
            el.className = 'data-item';
            if(type === 'damage') el.classList.add('status-damage');
            if(type === 'repair') el.classList.add('status-repaired');
            if(type === 'cost') el.classList.add('status-cost');
            if(type === 'receiving') el.classList.add('status-receiving');

            const checkboxId = `chk-${item.id}`;
            el.classList.add('unchecked-print'); 

            let htmlContent = '';

            if (showCheckbox) {
                htmlContent += `<input type="checkbox" class="item-checkbox" id="${checkboxId}" onchange="togglePrintItem('${checkboxId}')">`;
            }

            htmlContent += `
                <div class="item-content">
                    <div class="item-header">
                        <span class="item-title">${item.desc}</span>
                        <span class="item-date">${item.date}</span>
                    </div>
                    <span class="item-location">üìç ${item.location}</span>
                    <div style="margin-top:5px; font-size:0.9rem; color:#7f8c8d;">Oleh: ${item.user}</div>
            `;

            let costDisplay = '';
            if(type === 'cost') {
                costDisplay = `<div style="font-weight:bold; color:var(--success-color); margin-top:5px;">Rp ${parseInt(item.cost).toLocaleString('id-ID')}</div>`;
            }
            htmlContent += costDisplay;

            const editBtnHtml = `<button type="button" class="btn btn-sm btn-warning" onclick="editData('${type}', ${item.id})">EDIT</button>`;
            
            htmlContent += `
                    <div class="action-buttons">
                        ${editBtnHtml}
                    </div>
                </div>
            `;

            let mediaHtml = '';
            if (item.image) {
                mediaHtml = `<div style="margin-left:auto;"><img src="${item.image}" class="item-media" alt="Dokumentasi" onclick="window.open(this.src)"></div>`;
            }
            if (item.ttd) {
                mediaHtml += `<img src="${item.ttd}" class="ttd-preview" alt="TTD" style="margin-left:10px;">`;
            }
            htmlContent += mediaHtml;

            el.innerHTML = htmlContent;
            return el;
        }

        function togglePrintItem(checkboxId) {
            const checkbox = document.getElementById(checkboxId);
            const itemDiv = checkbox.closest('.data-item');
            
            if (checkbox.checked) {
                itemDiv.classList.remove('unchecked-print');
            } else {
                itemDiv.classList.add('unchecked-print');
            }
        }

        function toggleAllCheckboxes(checkedState) {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(chk => {
                chk.checked = checkedState;
                togglePrintItem(chk.id);
            });
        }

        function printSelected() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            let hasChecked = false;
            checkboxes.forEach(chk => {
                if(chk.checked) hasChecked = true;
            });

            if(!hasChecked) {
                showToast("Silakan pilih minimal satu data untuk dicetak!");
                return;
            }
            window.print();
        }

        function updateDashboard() {
            document.getElementById('stat-damage').innerText = appData.damage.length;
            document.getElementById('stat-repair').innerText = appData.repair.length;
            
            const totalCost = appData.cost.reduce((sum, item) => sum + parseInt(item.cost || 0), 0);
            document.getElementById('stat-cost').innerText = 'Rp ' + totalCost.toLocaleString('id-ID');

            let all = [];
            ['damage', 'cost', 'repair', 'receiving'].forEach(type => {
                appData[type].forEach(item => all.push({...item, type: type}));
            });
            all.sort((a, b) => b.id - a.id);
            const recent = all.slice(0, 5);

            const recentContainer = document.getElementById('dashboard-recent-list');
            recentContainer.innerHTML = '';
            if (recent.length === 0) {
                recentContainer.innerHTML = '<p style="color: #7f8c8d; padding: 10px;">Belum ada aktivitas.</p>';
                return;
            }

            recent.forEach(item => {
                let badgeColor = '#7f8c8d';
                let badgeText = item.type.toUpperCase();
                if (item.type === 'damage') badgeColor = '#e74c3c';
                if (item.type === 'repair') badgeColor = '#27ae60';
                if (item.type === 'cost') badgeColor = '#f39c12';
                if (item.type === 'receiving') badgeColor = '#3498db';

                const el = document.createElement('div');
                el.className = 'data-item';
                el.innerHTML = `
                    <div class="item-content">
                        <div class="item-header">
                            <span class="item-title">${item.desc.substring(0, 50)}...</span>
                            <span class="item-date">${item.date}</span>
                        </div>
                        <span class="item-location" style="background:${badgeColor}; color:white;">${badgeText} - ${item.location}</span>
                    </div>
                `;
                recentContainer.appendChild(el);
            });
        }

        function setupCanvas() {
            const canvas = document.getElementById('ttd-canvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mousemove', draw);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                startDraw(e.touches[0]);
            });
            canvas.addEventListener('touchend', endDraw);
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e.touches[0]);
            });

            function startDraw(e) {
                isDrawing = true;
                draw(e);
            }

            function endDraw() {
                isDrawing = false;
                ctx.beginPath();
            }

            function draw(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.pageX) - rect.left;
                const y = (e.clientY || e.pageY) - rect.top;

                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000';

                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
        }

        function clearCanvas() {
            const canvas = document.getElementById('ttd-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.className = "show";
            toast.innerText = message;
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }
    </script>
</body>
</html>